<!DOCTYPE html>
<html lang="zh-Hant">

<head>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç•°å¸¸å ±å‘Šè©³æƒ…</title>

  <script src="https://unpkg.com/docx@8.0.3/build/index.js"></script>

  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }

    h2 {
      margin-bottom: 12px;
    }

    .meta {
      margin-bottom: 20px;
      background: #f9f9f9;
      padding: 12px;
      border-radius: 6px;
    }

    .meta div {
      margin-bottom: 6px;
    }

    .files video {
      max-width: 200px;
      margin: 8px;
      border-radius: 6px;
      display: inline-block;
    }

    .files {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 12px;
    }

    .files img {
      width: 100%;
      border-radius: 6px;
    }

    ul.event-description li {
      padding: 6px 0;
      border-bottom: 1px solid #eee;
    }

    @media screen and (max-width: 600px) {
      body {
        padding: 12px;
        font-size: 16px;
      }

      h2 {
        font-size: 20px;
        text-align: center;
      }

      .meta {
        padding: 10px;
        font-size: 15px;
      }

      .meta div {
        margin-bottom: 10px;
        word-break: break-word;
      }

      .files {
        grid-template-columns: 1fr;
        /* âœ… å–®æ¬„æ’ç‰ˆ */
      }

      .files img,
      .files video {
        width: 100%;
        max-width: 100%;
      }

      label {
        display: block;
        margin-top: 12px;
        font-size: 15px;
      }

      select,
      button {
        width: 100%;
        margin-top: 6px;
        font-size: 16px;
      }

      a {
        display: block;
        text-align: center;
        margin-top: 20px;
        font-size: 16px;
      }
    }

    .photo-group {
      margin-bottom: 24px;
      padding: 12px;
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 6px;
    }

    .photo-group h4 {
      margin-bottom: 12px;
      font-size: 16px;
      font-weight: bold;
      border-bottom: 1px solid #eee;
      padding-bottom: 4px;
    }

    .photo-group .files {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      /* âœ… æ”¾å¤§æ ¼å­ */
      gap: 12px;
    }

    .photo-group .files img {
      max-width: 180px;
      /* âœ… æ”¾å¤§åœ–ç‰‡ */
      width: 100%;
      margin: auto;
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }

    .photo-group .files small {
      display: block;
      text-align: center;
      font-size: 12px;
      margin-top: 4px;
    }

    .status-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 20px 0;
      flex-wrap: wrap;
      /* âœ… æ‰‹æ©Ÿè‡ªå‹•æ›è¡Œ */
    }

    .status-row label {
      font-weight: bold;
      font-size: 15px;
    }

    .status-row select {
      padding: 6px 10px;
      font-size: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .status-row button {
      padding: 6px 12px;
      font-size: 15px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .status-row button:hover {
      background-color: #0056b3;
    }
  </style>

</head>

<body>

  <button id="exportBtn" onclick="exportToPPT()" disabled>ğŸ“¤ åŒ¯å‡ºç‚º PPT</button>
  <button id="exportWordBtn" onclick="exportToWord()">ğŸ“ åŒ¯å‡ºç‚º Word</button>


  <h2>ğŸ“Œ å¤§æ¨“ç•°å¸¸å ±å‘Šè©³æƒ…</h2>

  <div style="display: flex; justify-content: flex-start; gap: 12px; margin-top: 24px;">
    <a href="/abnormal.html" style="
    display: inline-block;
    padding: 10px 20px;
    background-color: #0fa13b;
    color: white;
    text-decoration: none;
    border-radius: 6px;
    font-weight: bold;
  ">
      è¿”å›å»ºç«‹ç•°å¸¸å ±å‘Š
    </a>

    <a href="/abnormal-query.html" style="
    display: inline-block;
    padding: 10px 20px;
    background-color: #0400ff;
    color: white;
    text-decoration: none;
    border-radius: 6px;
    font-weight: bold;
  ">
      è¿”å›ç•°å¸¸å ±å‘ŠæŸ¥è©¢
    </a>
  </div>

  <div id="meta" class="meta">è¼‰å…¥ä¸­...</div>

  <!-- âœ… ç§»å‡º meta å€å¡Šï¼Œç¨ç«‹å­˜åœ¨ -->
  <div id="descriptionBox" style="margin-top:16px;"></div>

  <div class="status-row">
    <label for="statusSelect">ğŸ”§ æ›´æ–°äº‹ä»¶ç‹€æ…‹</label>
    <select id="statusSelect">
      <option value="reported">å¾…å¯©æ ¸</option>
      <option value="processing">è™•ç†ä¸­</option>
      <option value="resolved">å·²è™•ç†</option>
      <option value="closed">å·²çµæ¡ˆ</option>
    </select>
    <button onclick="updateStatus()">æ›´æ–°ç•°å¸¸å ±å‘Šç‹€æ…‹</button>
    <!-- âœ… æ–°å¢é€™å€‹æŒ‰éˆ• -->
    <button onclick="editContent()" style="background-color: #ffc107; color: black;">
      âœï¸ ä¿®æ”¹ç•°å¸¸å ±å‘Šå…§å®¹
    </button>

  </div>


  <div id="files"></div>



  <script>

    document.getElementById('exportBtn').disabled = false;

    // æ’°å¯«è·³è½‰æˆ–é–‹å•Ÿç·¨è¼¯æ¨¡å¼
    function editContent() {
      const id = new URLSearchParams(location.search).get('id');
      if (!id) {
        alert('â— ç„¡æ³•å–å¾—äº‹ä»¶ç·¨è™Ÿ');
        return;
      }

      // âœ… è·³è½‰åˆ°ç·¨è¼¯é é¢ï¼ˆä½ å¯ä»¥æ”¹æˆä½ è‡ªå·±çš„è·¯å¾‘ï¼‰
      location.href = `/abnormal-edit.html?id=${id}`;
    }


    // æ’°å¯« PPT å‡½å¼ï¼ˆåˆå§‹ç‰ˆæœ¬ï¼‰
    function exportToPPT() {
      if (typeof pptxgen !== 'function') {
        alert('âŒ pptxgen å°šæœªè¼‰å…¥ï¼Œè«‹ç¢ºèª CDN è·¯å¾‘æ˜¯å¦æ­£ç¢º');
        return;
      }

      const pptx = new pptxgen();
      const slide = pptx.addSlide();

      const metaText = document.getElementById('meta')?.innerText || '';
      const descriptionText = document.getElementById('descriptionBox')?.innerText || '';

      slide.addText('ç•°å¸¸å ±å‘Šè©³æƒ…', { x: 0.5, y: 0.3, fontSize: 24, bold: true });
      slide.addText(metaText, { x: 0.5, y: 1.0, fontSize: 14, w: 8.5, h: 2.5, wrap: true });
      slide.addText(descriptionText, { x: 0.5, y: 3.6, fontSize: 14, w: 8.5, h: 2.5, wrap: true });

      // âœ… åŒ¯å‡ºé™„åœ–
      const allImages = window.allFiles?.filter(f => f.mimetype?.startsWith('image')) || [];
      for (const f of allImages) {
        const imgSlide = pptx.addSlide();
        imgSlide.addImage({
          path: f.url,
          x: 0.5,
          y: 1.0,
          w: 8.5,
          h: 5.5
        });
        imgSlide.addText('ğŸ“· ' + (f.category || 'æœªåˆ†é¡'), { x: 0.5, y: 0.3, fontSize: 18, bold: true });
      }

      pptx.writeFile('ç•°å¸¸å ±å‘Š.pptx');
    }


    // âœ… è½‰ Word æ–‡ä»¶
    async function exportToWord() {
      const { Document, Packer, Paragraph, HeadingLevel, ImageRun } = window.docx;

      if (!window.meta) {
        alert('âŒ å°šæœªè¼‰å…¥äº‹ä»¶è³‡æ–™');
        return;
      }

      const meta = window.meta;
      const allFiles = window.allFiles || [];

      const doc = new Document();

      doc.addSection({
        children: [
          new Paragraph({ text: 'ç•°å¸¸å ±å‘Šè©³æƒ…', heading: HeadingLevel.TITLE }),
          new Paragraph(`äº‹ä»¶ç·¨è™Ÿï¼š${meta.displayId || meta.id}`),
          new Paragraph(`å¤§æ¨“ï¼š${meta.building}`),
          new Paragraph(`ä¸»é¡å‹ï¼š${meta.type}`),
          new Paragraph(`æ¨£å‹ï¼š${meta.subtype || 'æœªå¡«å¯«'}`),
          new Paragraph(`ç•°å¸¸äº‹ç”±ï¼š${meta.reason || 'æœªå¡«å¯«'}`),
          new Paragraph(`ç™¼ç”Ÿæ™‚é–“ï¼š${new Date(meta.occurTime).toLocaleString()}`),
          new Paragraph(`å›å ±äººï¼š${meta.reportedBy}`),
          new Paragraph(`ç‹€æ…‹ï¼š${meta.status}`),
          new Paragraph(`å»ºç«‹æ™‚é–“ï¼š${new Date(meta.createdAt).toLocaleString()}`),
          new Paragraph({ text: 'ç•°å¸¸æè¿°', heading: HeadingLevel.HEADING_2 }),
          ...parseDescriptionTextOnly(meta.description).map(line => new Paragraph(line)),
          new Paragraph({ text: 'é™„åœ–', heading: HeadingLevel.HEADING_2 })
        ]
      });

      const firstImage = allFiles.find(f => f.mimetype?.startsWith('image'));
      if (firstImage) {
        const fullUrl = location.origin + firstImage.url;
        const imgBlob = await fetch(fullUrl).then(r => r.blob());

        const imgBuffer = await imgBlob.arrayBuffer();

        doc.addSection({
          children: [
            new Paragraph('ğŸ“· ' + (firstImage.category || 'æœªåˆ†é¡')),
            new Paragraph(
              new ImageRun({
                data: imgBuffer,
                transformation: { width: 480, height: 320 }
              })
            )
          ]
        });
      }

      const blob = await Packer.toBlob(doc);
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ç•°å¸¸å ±å‘Š.docx';
      a.click();
    }



    const statusMap = {
      reported: { label: 'å¾…å¯©æ ¸', color: '#6c757d' },     // ç°è‰²
      processing: { label: 'è™•ç†ä¸­', color: '#007bff' },   // è—è‰²
      resolved: { label: 'å·²è™•ç†', color: '#28a745' },     // ç¶ è‰²
      closed: { label: 'å·²çµæ¡ˆ', color: '#ff0000' }        // ç´…è‰²
    };

    async function loadDetail() {
      const params = new URLSearchParams(location.search);
      const id = params.get('id');
      if (!id) {
        document.getElementById('meta').innerText = 'â— ç¼ºå°‘äº‹ä»¶ç·¨è™Ÿ';
        return;
      }

      try {
        const resp = await fetch(`/api/abnormal-events/${id}`);
        if (!resp.ok) throw new Error(await resp.text());

        const data = await resp.json();
        console.log('ğŸ“‚ æ‰€æœ‰æª”æ¡ˆ:', data.files);
        window.meta = data;
        window.allFiles = [
          ...data.files.filter(f => f.category === 'initial'),
          ...data.files.filter(f => f.category === 'processing'),
          ...data.files.filter(f => f.category === 'resolved'),
          ...data.files.filter(f => f.category === 'general' || !f.category)
        ];

        const initialFiles = data.files.filter(f => f.category === 'initial');
        const processingFiles = data.files.filter(f => f.category === 'processing');
        const resolvedFiles = data.files.filter(f => f.category === 'resolved');
        const generalFiles = data.files.filter(f => f.category === 'general' || !f.category);

        document.getElementById('statusSelect').value = data.status;

        // âœ… æ’å…¥é€™è£¡
        const metaDiv = document.getElementById('meta');
        metaDiv.innerHTML = `
      <div><strong>äº‹ä»¶ç·¨è™Ÿï¼š</strong><code>${data.displayId || data.id}</code></div>
      <div><strong>å¤§æ¨“ï¼š</strong>${data.building}</div>
      <div><strong>ä¸»é¡å‹ï¼š</strong>${data.type}</div>
      <div><strong>ç•°å¸¸æ¨£å‹ï¼š</strong>${data.subtype || 'ï¼ˆæœªå¡«å¯«ï¼‰'}</div>
      <div><strong>ç•°å¸¸äº‹ç”±ï¼š</strong>${data.reason || 'ï¼ˆæœªå¡«å¯«ï¼‰'}</div>    <!-- âœ… æ’å…¥é€™å€‹å®¹å™¨ -->
      <div><strong>ç™¼ç”Ÿæ™‚é–“ï¼š</strong>${new Date(data.occurTime).toLocaleString('zh-TW', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        })}</div>
      <div id="descriptionBox"></div>   <!-- âœ… æ’å…¥é€™å€‹å®¹å™¨ -->
      <div><strong>å›å ±äººï¼š</strong>${data.reportedBy}</div>
      <div>
        <strong>ç‹€æ…‹ï¼š</strong>
        <span style="color:${statusMap[data.status]?.color || '#000'}; font-weight:bold;">
          ${statusMap[data.status]?.label || data.status}
       </span>
      </div>
      <div><strong>å»ºç«‹æ™‚é–“ï¼š</strong>${new Date(data.createdAt).toLocaleString()}</div>
    `;

        renderDescription(data.description); // âœ… æè¿°ï¼šå‡½å¼

        const filesDiv = document.getElementById('files');
        renderFileGroup('ğŸ“¸ åˆæ­¥ç™¼ç”Ÿç…§ç‰‡', initialFiles);
        renderFileGroup('ğŸ› ï¸ è™•ç†ä¸­ç…§ç‰‡', processingFiles);
        renderFileGroup('âœ… è™•ç†å®Œæˆç…§ç‰‡', resolvedFiles);
        renderFileGroup('ğŸ“‚ å…¶ä»–ç…§ç‰‡', generalFiles);

      } catch (err) {
        document.getElementById('meta').innerText = 'âŒ ç„¡æ³•è¼‰å…¥äº‹ä»¶ï¼š' + err.message;
      }
    }

    loadDetail();

    async function updateStatus() {
      const pwd = prompt('è«‹è¼¸å…¥ç‹€æ…‹æ›´æ–°å¯†ç¢¼');
      if (pwd !== '2301') {
        alert('âŒ å¯†ç¢¼éŒ¯èª¤ï¼Œç„¡æ³•æ›´æ–°ç‹€æ…‹');
        return;
      }
      const params = new URLSearchParams(location.search);
      const id = params.get('id');
      const status = document.getElementById('statusSelect').value;

      try {
        const resp = await fetch(`/api/abnormal-events/${id}/status`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status })
        });
        if (!resp.ok) throw new Error(await resp.text());
        alert('âœ… ç‹€æ…‹å·²æ›´æ–°');
        location.reload();
      } catch (err) {
        alert('âŒ æ›´æ–°å¤±æ•—ï¼š' + err.message);
      }
    }

    // âœ… ç‰ˆé¢èª¿æ•´
    function renderDescription(raw) {
      const box = document.getElementById('descriptionBox');
      const html = `
    <div style="margin-top:12px;">
      
      <ul class="event-description" style="list-style:none; padding-left:0; margin-top:8px;">
        ${parseDescription(raw)}
      </ul>
    </div>
  `;
      box.innerHTML = html;
    }

    // âœ… æ’ç‰ˆ2
    function parseDescription(text) {
      const blocks = {};
      const lines = text.split('\n');
      let currentLabel = null;

      for (const line of lines) {
        const labelMatch = line.match(/^(.+?)ï¼š(.*)$/);
        if (labelMatch) {
          currentLabel = labelMatch[1].trim();
          const content = labelMatch[2].trim();
          blocks[currentLabel] = content;
        } else if (currentLabel) {
          blocks[currentLabel] += '\n' + line.trim();
        }
      }

      return Object.entries(blocks).map(([label, content]) => {
        if (label === 'ç•°å¸¸èªªæ˜') {
          // æ¯è¡Œå¼·åˆ¶æ›è¡Œé¡¯ç¤º
          const forcedLines = content.split('\n').map(line => line.trim()).filter(Boolean);
          return `<li><strong>${label}ï¼š</strong><br>${forcedLines.map(l => `<div>${l}</div>`).join('')}</li>`;
        } else {
          // ä¸€èˆ¬æ¬„ä½ï¼šä¿ç•™æ›è¡Œä½†ä¸å¼·åˆ¶åˆ†æ®µ
          return `<li><strong>${label}ï¼š</strong>${content.replace(/\n/g, '<br>')}</li>`;
        }
      }).join('');
    }


    // âœ… çµ¦ Word åŒ¯å‡ºç”¨çš„ç´”æ–‡å­—è§£æå™¨
    function parseDescriptionTextOnly(text) {
      const blocks = {};
      const lines = text.split('\n');
      let currentLabel = null;

      for (const line of lines) {
        const labelMatch = line.match(/^(.+?)ï¼š(.*)$/);
        if (labelMatch) {
          currentLabel = labelMatch[1].trim();
          const content = labelMatch[2].trim();
          blocks[currentLabel] = content;
        } else if (currentLabel) {
          blocks[currentLabel] += '\n' + line.trim();
        }
      }

      // å›å‚³ç´”æ–‡å­—é™£åˆ—ï¼ˆä¸å« HTMLï¼‰
      return Object.entries(blocks).flatMap(([label, content]) => {
        const lines = content.split('\n').map(line => line.trim()).filter(Boolean);
        return [`${label}ï¼š`, ...lines];
      });
    }



    // ç¶²æ ¼æ’ç‰ˆå‡½å¼
    function renderFileGroup(title, files) {
      if (!files || files.length === 0) return;

      const filesDiv = document.getElementById('files');

      const groupWrapper = document.createElement('div');
      groupWrapper.className = 'photo-group';

      const heading = document.createElement('h4');
      heading.textContent = title;
      groupWrapper.appendChild(heading);

      const group = document.createElement('div');
      group.className = 'files';

      for (const f of files) {
        const block = document.createElement('div');
        block.style.display = 'flex';
        block.style.flexDirection = 'column';
        block.style.alignItems = 'center';

        if (f.mimetype?.startsWith('image')) {
          const img = document.createElement('img');
          img.src = f.url;
          img.alt = '';

          // âœ… æ’å…¥é€™è£¡ï¼šå¾®èª¿åœ–ç‰‡æ¨£å¼
          img.style.maxWidth = '160px';         // ç¨å¾®æ”¾å¤§
          img.style.margin = '8px';
          img.style.borderRadius = '6px';
          img.style.objectFit = 'cover';
          img.style.boxShadow = '0 0 6px rgba(0,0,0,0.2)';

          // âœ… åŠ ä¸Š hover æ”¾å¤§æ•ˆæœ
          img.style.transition = 'transform 0.2s ease';
          img.onmouseover = () => img.style.transform = 'scale(1.05)';
          img.onmouseout = () => img.style.transform = 'scale(1)';


          block.appendChild(img);
        }
        group.appendChild(block);
      }

      groupWrapper.appendChild(group);
      filesDiv.appendChild(groupWrapper);
    }


  </script>

  <hr />
  <p>
    <a href="/abnormal-query.html" style="text-decoration:none;">
      ğŸ”™ è¿”å›ç•°å¸¸äº‹ä»¶åˆ—è¡¨
    </a>
  </p>
</body>

</html>