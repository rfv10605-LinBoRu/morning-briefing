<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <title>å¤§æ¨“ç•°å¸¸å ±å‘ŠæŸ¥è©¢</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 1000px;
      margin: auto;
    }

    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
    }

    select {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
      box-sizing: border-box;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 24px;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    th {
      background: #f0f0f0;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      max-width: 1000px;
      margin: auto;
      background-color: #f9f9f9;
      color: #333;
    }

    h2 {
      text-align: center;
      margin-bottom: 24px;
      color: #007bff;
    }

    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
      font-size: 16px;
    }

    select,
    input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 15px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 24px;
      background-color: #fff;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
      font-size: 14px;
    }

    th {
      background: #f0f0f0;
      font-weight: 600;
    }

    a {
      color: #007bff;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    @media screen and (max-width: 768px) {
      body {
        padding: 10px;
      }

      table,
      thead,
      tbody,
      th,
      td,
      tr {
        display: block;
      }

      thead {
        display: none;
      }

      tr {
        margin-bottom: 16px;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 10px;
        background-color: #fff;
      }

      td {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border: none;
        border-bottom: 1px solid #eee;
      }

      td::before {
        content: attr(data-label);
        font-weight: bold;
        color: #555;
      }
    }
  </style>
</head>

<body>
  <h2>ğŸ“‘ å¤§æ¨“ç•°å¸¸å ±å‘ŠæŸ¥è©¢</h2>

  <label>ğŸ“ ç¯©é¸åˆ†å€
    <select id="zoneSelect">
      <option value="">å…¨éƒ¨</option>
      <option value="å°åŒ—åŒ—å€">å°åŒ—åŒ—å€</option>
      <option value="å°åŒ—å—å€">å°åŒ—å—å€</option>
      <option value="é†«ç™‚å°ˆå€">é†«ç™‚å°ˆå€</option>
      <option value="å°ç£ä¸­å€">å°ç£ä¸­å€</option>
      <option value="å°ç£å—å€">å°ç£å—å€</option>
    </select>
  </label>

  <label>ğŸ¢ ç¯©é¸å¤§æ¨“
    <select id="filterBuilding">
      <option value="">å…¨éƒ¨</option>
    </select>
  </label>

  <label>âš ï¸ ç¯©é¸ä¸»é¡å‹
    <select id="filterType">
      <option value="">å…¨éƒ¨</option>
      <option value="å¤§æ¨“ç½å®³äº‹ä»¶">å¤§æ¨“ç½å®³äº‹ä»¶</option>
      <option value="å¤§æ¨“è¨­å‚™æ•…éšœ">å¤§æ¨“è¨­å‚™æ•…éšœ</option>
      <option value="æ„å¤–äº‹æ•…">æ„å¤–äº‹æ•…</option>
      <option value="å…¶ä»–äº‹ä»¶">å…¶ä»–äº‹ä»¶</option>
    </select>
  </label>

  <label>ğŸ§© ç¯©é¸æ¨£å‹
    <select id="filterSubtype">
      <option value="">å…¨éƒ¨</option>
    </select>
  </label>

  <label>ğŸ” æŸ¥è©¢äº‹ä»¶ç·¨è™Ÿ
    <input type="text" id="filterEventId" placeholder="è«‹è¼¸å…¥äº‹ä»¶ç·¨è™Ÿï¼ˆå¦‚ 20251110-L126-001ï¼‰"
      style="width:100%; padding:8px; margin-top:6px;" />
  </label>

  <p style="text-align:left; margin-top:24px;">
    <a href="/abnormal.html" style="
        display: inline-block;
        padding: 10px 20px;
        background-color: #0fa13b;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-weight: bold;
        ">
      è¿”å›å»ºç«‹ç•°å¸¸å ±å‘Š
    </a>
  </p>

  <table>
    <thead>
      <tr>
        <th>å»ºç«‹æ™‚é–“</th>
        <th>äº‹ä»¶ç·¨è™Ÿ</th>
        <th>å¤§æ¨“</th>
        <th>ä¸»é¡å‹</th>
        <th>æ¨£å‹</th>
        <th>å›å ±äºº</th>
        <th>ç‹€æ…‹</th>
        <th>æ“ä½œï¼ˆåˆªé™¤ï¼ä¸‹è¼‰ï¼‰</th> <!-- âœ… æ–°å¢æ“ä½œæ¬„ -->
      </tr>
    </thead>

    <tbody id="eventTableBody">
      <tr>
        <td colspan="7">è¼‰å…¥ä¸­...</td>
      </tr>
    </tbody>
  </table>

  <script>
    //âœ… åŠ å…¥ä¸‹è¼‰å‡½å¼
    async function downloadZip(id) {
      try {
        const resp = await fetch(`/api/abnormal-events/${id}`);
        if (!resp.ok) throw new Error('æ‰¾ä¸åˆ°äº‹ä»¶');

        const meta = await resp.json();
        const folderName = meta.id; // âœ… æ”¹æˆç”¨ id
        const zipUrl = `/download-folder?folder=${encodeURIComponent(folderName)}`;

        const a = document.createElement('a');
        a.href = zipUrl;
        a.download = `${folderName}.zip`;
        document.body.appendChild(a);
        a.click();
        a.remove();
      } catch (err) {
        alert('âŒ ç„¡æ³•ä¸‹è¼‰ ZIPï¼š' + err.message);
        console.error('ä¸‹è¼‰ ZIP éŒ¯èª¤:', err);
      }
    }

    // å‰ç«¯æ–°å¢åˆªé™¤æŒ‰éˆ•(å¯†ç¢¼)
    async function confirmDelete(id) {
      const pwd = prompt('è«‹è¼¸å…¥åˆªé™¤å¯†ç¢¼');
      if (pwd !== '2301') {               // âœ… å¯†ç¢¼è®Šæ›´
        alert('âŒ å¯†ç¢¼éŒ¯èª¤ï¼Œç„¡æ³•åˆªé™¤');
        return;
      }

      if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†äº‹ä»¶å—ï¼Ÿ')) return;

      try {
        const resp = await fetch(`/api/abnormal-events/${id}`, {
          method: 'DELETE'
        });
        if (!resp.ok) throw new Error(await resp.text());
        alert('âœ… å·²æˆåŠŸåˆªé™¤');
        loadEvents(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
      } catch (err) {
        alert('âŒ åˆªé™¤å¤±æ•—ï¼š' + err.message);
      }
    }


    // æ–°å¢æ‰‹å‹•è¼¸å…¥äº‹ä»¶ç·¨è™Ÿ2
    document.getElementById('filterEventId').addEventListener('input', () => {
      const eventId = document.getElementById('filterEventId').value.trim();
      if (eventId) {
        loadEvents({ eventId }); // âœ… æŸ¥è©¢æŒ‡å®šäº‹ä»¶ç·¨è™Ÿ
      } else {
        loadEvents(); // âœ… æ¸…ç©ºå¾Œé‡æ–°è¼‰å…¥å…¨éƒ¨
      }
    });

    // åˆå§‹åŒ–é é¢æ™‚è¼‰å…¥å…¨éƒ¨äº‹ä»¶ï¼ˆå¯é¸ï¼‰
    window.addEventListener('DOMContentLoaded', () => {
      loadEvents(); // åˆå§‹è¼‰å…¥å…¨éƒ¨äº‹ä»¶
    });




    // æ”¯æ´å¤šæ£Ÿå¤§æ¨“æŸ¥è©¢
    async function loadEvents({ buildings = [], type = '', subtype = '', status = '', eventId = '' } = {}) {
      const eventTableBody = document.getElementById('eventTableBody');
      eventTableBody.innerHTML = '';

      // âœ… å¦‚æœæœ‰è¼¸å…¥äº‹ä»¶ç·¨è™Ÿï¼Œç›´æ¥æŸ¥è©¢è©²äº‹ä»¶
      if (eventId) {
        try {
          const resp = await fetch(`/api/abnormal-events?displayId=${encodeURIComponent(eventId)}`);
          if (!resp.ok) throw new Error(await resp.text());
          const events = await resp.json();
          const eventList = Array.isArray(events) ? events : [events]; // âœ… ä¿è­‰æ˜¯é™£åˆ—

          // âœ… å»é‡ displayId + id
          const uniqueEvents = [];
          const seen = new Set();
          for (const e of eventList) {
            const key = `${e.displayId}-${e.id}`;
            if (seen.has(key)) continue;
            seen.add(key);
            uniqueEvents.push(e);
          }


          if (uniqueEvents.length === 0) {
            eventTableBody.innerHTML = `<tr><td colspan="7">âŒ æŸ¥ç„¡äº‹ä»¶ç·¨è™Ÿï¼š${eventId}</td></tr>`;
            return;
          }

          for (const e of uniqueEvents) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
          <td data-label="å»ºç«‹æ™‚é–“">${new Date(e.createdAt).toLocaleDateString()}</td>
          <td data-label="äº‹ä»¶ç·¨è™Ÿ"><a href="/abnormal-detail.html?id=${e.id}" target="_blank"><code>${e.displayId || e.id}</code></a></td>
          <td data-label="å¤§æ¨“">${e.building}</td>
          <td data-label="ä¸»é¡å‹">${e.type}</td>
          <td data-label="æ¨£å‹">${e.subtype || ''}</td>
          <td data-label="å›å ±äºº">${e.reportedBy || ''}</td>
          <td data-label="ç‹€æ…‹" style="color:${statusMap[e.status]?.color || '#000'}; font-weight:bold;">
            ${statusMap[e.status]?.label || e.status}
          </td>
          <td data-label="æ“ä½œ">
            <button onclick="confirmDelete('${e.id}')">ğŸ—‘ åˆªé™¤</button>
            <button onclick="downloadZip('${e.id}')" style="margin-left: 8px;">ğŸ“¦ ä¸‹è¼‰ZIP</button>
          </td>
        `;
            eventTableBody.appendChild(tr);
          }
        } catch (err) {
          console.error('âŒ æŸ¥è©¢äº‹ä»¶ç·¨è™ŸéŒ¯èª¤:', err);
          eventTableBody.innerHTML = `<tr><td colspan="7">âŒ æŸ¥è©¢å¤±æ•—ï¼š${err.message}</td></tr>`;
        }
        return;
      }

      // âœ… å¦å‰‡åŸ·è¡Œä¸€èˆ¬æ¢ä»¶æŸ¥è©¢
      if (buildings.length === 0) {
        const selectedBuilding = document.getElementById('filterBuilding').value;
        if (selectedBuilding) buildings = [selectedBuilding];
      }
      if (!type) type = document.getElementById('filterType').value;
      if (!subtype) subtype = document.getElementById('filterSubtype').value;

      const allEvents = [];
      for (const b of buildings.length ? buildings : ['']) {
        const params = new URLSearchParams();
        if (b) params.append('building', b);
        if (type) params.append('type', type);
        if (subtype) params.append('subtype', subtype);
        if (status) params.append('status', status);

        try {
          const resp = await fetch(`/api/abnormal-events?${params.toString()}`);
          const data = await resp.json();
          allEvents.push(...data);
        } catch (err) {
          console.error('âŒ æŸ¥è©¢äº‹ä»¶éŒ¯èª¤:', err);
        }
      }

      if (allEvents.length === 0) {
        eventTableBody.innerHTML = `<tr><td colspan="7">ç›®å‰æ²’æœ‰ç•°å¸¸äº‹ä»¶</td></tr>`;
        return;
      }

      // âœ… åŠ å…¥å»é‡ displayId
      const uniqueEvents = [];
      const seen = new Set();
      for (const e of allEvents) {
        const key = `${e.displayId}-${e.id}`;
        if (seen.has(key)) continue;
        seen.add(key);
        uniqueEvents.push(e);
      }

      for (const e of uniqueEvents) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
      <td>${new Date(e.createdAt).toLocaleDateString()}</td>
      <td><a href="/abnormal-detail.html?id=${e.id}" target="_blank"><code>${e.displayId || e.id}</code></a></td>
      <td>${e.building}</td>
      <td>${e.type}</td>
      <td>${e.subtype || ''}</td>
      <td>${e.reportedBy || ''}</td>
      <td style="color:${statusMap[e.status]?.color || '#000'}; font-weight:bold;">
        ${statusMap[e.status]?.label || e.status}
      </td>
      <td>
        <button onclick="confirmDelete('${e.id}')">ğŸ—‘ åˆªé™¤</button>
        <button onclick="downloadZip('${e.id}')" style="margin-left: 8px;">ğŸ“¦ ä¸‹è¼‰ZIP</button>
      </td>
    `;
        eventTableBody.appendChild(tr);
      }
    }






    // äº‹ä»¶ç‹€æ…‹&ç‹€æ…‹å°ç…§è¡¨ï¼ˆå«ä¸­æ–‡èˆ‡é¡è‰²ï¼‰
    const statusMap = {
      reported: { label: 'å¾…å¯©æ ¸', color: '#6c757d' },     // ç°è‰²
      processing: { label: 'è™•ç†ä¸­', color: '#007bff' },   // è—è‰²
      resolved: { label: 'å·²è™•ç†', color: '#28a745' },     // ç¶ è‰²
      closed: { label: 'å·²çµæ¡ˆ', color: '#ff0000' }        // ç´…è‰²
    };


    const buildingMap = {
      'å°åŒ—åŒ—å€': ['äºå¤ªç¶“è²¿'],
      'å°åŒ—å—å€': ['æ¾å±±é‡‘è', 'å‰ç»é‡‘è', 'å…¨çƒæ°‘æ¬Š', 'ç”¢ç‰©å¤§æ¨“', 'èŠ·è‹±å¤§æ¨“', 'è¯èˆªå¤§æ¨“',
        'å—äº¬ç§‘æŠ€', 'äº’åŠ©ç‡Ÿé€ ', 'æ‘©å¤©å¤§æ¨“', 'æ–°èŠè¾²æœƒ', 'å„’é´»ä¼æ¥­', 'æ–°æ¿å‚‘ä»•å ¡',
        'æ–°æ¿é‡‘è', 'æ¡ƒåœ’é‡‘è', 'æ–°ç«¹å¤§æ¨“', 'ç«¹ç§‘å¤§æ¨“', 'é ­ä»½å¤§æ¨“'],
      'é†«ç™‚å°ˆå€': ['æ–°å…‰é†«é™¢'],
      'å°ç£ä¸­å€': ['å°ä¸­æƒ åœ‹'],
      'å°ç£å—å€': ['å°å—å¤§æ¨“']
    };

    // ä¿®æ­£åˆ†å€ç¯©é¸
    document.getElementById('zoneSelect').addEventListener('change', () => {
      const zone = document.getElementById('zoneSelect').value;
      const buildingSelect = document.getElementById('filterBuilding');

      // æ¸…ç©ºå¤§æ¨“é¸å–®
      buildingSelect.innerHTML = '<option value="">å…¨éƒ¨å¤§æ¨“</option>';

      // âœ… æ ¹æ“šåˆ†å€æ›´æ–°å¤§æ¨“é¸å–®
      const buildings = buildingMap[zone] || [];
      for (const b of buildings) {
        const opt = document.createElement('option');
        opt.value = b;
        opt.textContent = b;
        buildingSelect.appendChild(opt);
      }

      // âœ… æŸ¥è©¢è©²åˆ†å€æ‰€æœ‰å¤§æ¨“äº‹ä»¶
      loadEvents({ buildings });
    });



    const subTypeMap = {
      'å¤§æ¨“ç½å®³äº‹ä»¶': ['åœ°éœ‡', 'ç«ç½', 'é¢±é¢¨', 'æ°´ç½', 'ç™¼ç¾çˆ†è£‚ç‰©', 'å¤§æ¨“æ»²æ°´æˆ–ç©æ°´', 'å¤§æ¨“é­å—å¤–åŠ›å—æ', 'çˆ†æ°´ç®¡'],
      'å¤§æ¨“è¨­å‚™æ•…éšœ': ['åœç©ºèª¿', 'å¤§æ¨“åœæ°´', 'å¤§æ¨“åœé›»'],
      'æ„å¤–äº‹æ•…': ['ç«Šç›œäº‹ä»¶', 'äººå“¡å‚·äº¡', 'é›»æ¢¯é—œäºº'],
      'å…¶ä»–äº‹ä»¶': ['è­¦å¯Ÿè‡³å¤§æ¨“è¾¦æ¡ˆ', 'ç¾¤çœ¾æŠ—çˆ­', 'åª’é«”å ±å°äº‹ä»¶']
    };

    document.getElementById('filterType').addEventListener('change', () => {
      const type = document.getElementById('filterType').value;
      const subSelect = document.getElementById('filterSubtype');
      subSelect.innerHTML = '<option value="">å…¨éƒ¨</option>';
      if (subTypeMap[type]) {
        for (const sub of subTypeMap[type]) {
          const opt = document.createElement('option');
          opt.value = sub;
          opt.textContent = sub;
          subSelect.appendChild(opt);
        }
      }
      loadEvents();
    });

    document.getElementById('filterBuilding').addEventListener('change', () => {
      const building = document.getElementById('filterBuilding').value;
      loadEvents({ buildings: building ? [building] : [] });
    });

    //document.getElementById('filterSubtype').addEventListener('change', loadEvents);
    document.getElementById('filterSubtype').addEventListener('change', () => {
      const subtype = document.getElementById('filterSubtype').value;
      const building = document.getElementById('filterBuilding').value;
      const type = document.getElementById('filterType').value;
      loadEvents({
        buildings: building ? [building] : [],
        type,
        subtype
      });
    });

    //loadEvents();
  </script>


</body>

</html>