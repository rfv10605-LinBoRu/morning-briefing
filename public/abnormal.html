<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <title>å¤§æ¨“ç•°å¸¸å ±å‘Š</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }

    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
    }

    select,
    textarea {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
      box-sizing: border-box;
    }

    button {
      margin-top: 12px;
      padding: 10px 14px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .queryBox {
      border: 2px solid #007bff;
      padding: 16px;
      border-radius: 8px;
      background: #f8faff;
      margin-top: 24px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      font-family: "Segoe UI", "Noto Sans TC", sans-serif;
      font-size: 16px;
      line-height: 1.5;
    }

    form label {
      display: flex;
      flex-direction: column;
      font-weight: 500;
    }

    form input,
    form select,
    form textarea {
      margin-top: 6px;
      padding: 8px;
      font-size: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 100%;
      box-sizing: border-box;
    }

    form textarea {
      resize: vertical;
    }

    form button {
      grid-column: span 2;
      padding: 10px 16px;
      font-size: 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    form button:hover {
      background-color: #0056b3;
    }

    /* âœ… æ‰‹æ©Ÿç‰ˆæ’ç‰ˆï¼šæ”¹æˆä¸€æ¬„ */
    @media (max-width: 768px) {
      form {
        grid-template-columns: 1fr;
      }

      form button {
        grid-column: span 1;
      }
    }
  </style>
</head>

<body>
  <h2>ğŸ“‹ å»ºç«‹å¤§æ¨“ç•°å¸¸å ±å‘Š</h2>

  <form id="abnormalForm">
    <label>ğŸ“ é¸æ“‡åˆ†å€(å¿…å¡«)
      <select id="zoneSelect">
        <option value="" disabled selected hidden>è«‹é¸æ“‡</option>
        <option value="å°åŒ—åŒ—å€">å°åŒ—åŒ—å€</option>
        <option value="å°åŒ—å—å€">å°åŒ—å—å€</option>
        <option value="é†«ç™‚å°ˆå€">é†«ç™‚å°ˆå€</option>
        <option value="å°ç£ä¸­å€">å°ç£ä¸­å€</option>
        <option value="å°ç£å—å€">å°ç£å—å€</option>
      </select>
    </label>

    <label>ğŸ¢ å›å ±å¤§æ¨“(å¿…å¡«)
      <select id="reportBuilding">
        <option value="">è«‹é¸æ“‡</option>
      </select>
    </label>

    <label>âš ï¸ ä¸»é¡å‹(å¿…å¡«)
      <select id="mainType">
        <option value="">è«‹é¸æ“‡</option>
        <option value="å¤§æ¨“ç½å®³äº‹ä»¶">å¤§æ¨“ç½å®³äº‹ä»¶</option>
        <option value="å¤§æ¨“è¨­å‚™æ•…éšœ">å¤§æ¨“è¨­å‚™æ•…éšœ</option>
        <option value="æ„å¤–äº‹æ•…">æ„å¤–äº‹æ•…</option>
        <option value="å…¶ä»–äº‹ä»¶">å…¶ä»–äº‹ä»¶</option>
      </select>
    </label>

    <label>ğŸ§© ç•°å¸¸æ¨£å‹(å¿…å¡«)
      <select id="subType">
        <option value="">è«‹å…ˆé¸æ“‡ä¸»é¡å‹</option>
      </select>
    </label>

    <label>ğŸ“Œ ç•°å¸¸äº‹ç”±(å¿…å¡«)
      <input type="text" id="reason" placeholder="ä¾‹å¦‚ï¼šCæ£Ÿä¸»å¹¹ç®¡å µå¡ç•°å¸¸å ±å‘Š" rows="3" />
    </label>

    <label>ğŸ“ ç™¼ç”Ÿåœ°é»(å¿…å¡«)
      <input type="text" id="location" placeholder="ä¾‹å¦‚ï¼šCæ£Ÿåœ°ä¸‹å®¤é›»æ¢¯å£" />
    </label>

    <label>ğŸ•’ ç™¼ç”Ÿæ™‚é–“(å¿…å¡«)
      <input type="datetime-local" id="occurTime" />
    </label>

    <label>ğŸ“ ç•°å¸¸èªªæ˜(å¿…å¡«)
      <textarea id="phenomenon" rows="2" placeholder="è«‹ç°¡è¿°ç¾å ´ç•°å¸¸æƒ…æ³"></textarea>
    </label>

    <label>ğŸ” åˆæ­¥åˆ¤æ–·
      <textarea id="judgement" rows="2" placeholder="ä¾‹å¦‚ï¼šå¯èƒ½ç‚ºä¸»å¹¹ç®¡å µå¡"></textarea>
    </label>

    <label>ğŸ› ï¸ è™•ç†æ–¹å¼
      <textarea id="handling" rows="2" placeholder="ä¾‹å¦‚ï¼šå·²è¯ç¹«å» å•†ç–é€šï¼Œè™•ç†å®Œæˆ"></textarea>
    </label>

    <label>ğŸ“Œ å»ºè­°äº‹é …
      <textarea id="suggestion" rows="2" placeholder="ä¾‹å¦‚ï¼šæé†’ä½æˆ¶å‹¿ä¸Ÿç•°ç‰©ï¼Œå®‰æ’å®šæœŸæª¢æŸ¥"></textarea>
    </label>

    <label>ğŸ“¸ åˆæ­¥ç™¼ç”Ÿç…§ç‰‡ï¼ˆå¯å¤šå¼µï¼‰
      <input type="file" id="photoInitial" multiple accept="image/*" />
    </label>
    <div id="previewInitial"></div>

    <label>ğŸ› ï¸ è™•ç†ä¸­ç…§ç‰‡ï¼ˆå¯å¤šå¼µï¼‰
      <input type="file" id="photoProcessing" multiple accept="image/*" />
    </label>
    <div id="previewProcessing"></div>

    <label>âœ… è™•ç†å®Œæˆç…§ç‰‡ï¼ˆå¯å¤šå¼µï¼‰
      <input type="file" id="photoResolved" multiple accept="image/*" />
    </label>
    <div id="previewResolved"></div>

    <label>ğŸ“‚ å…¶ä»–ç…§ç‰‡ï¼ˆå¯å¤šå¼µï¼‰
      <input type="file" id="photoInput" multiple accept="image/*" />
    </label>
    <div id="previewArea" style="margin-top:12px;"></div>

    <label>ğŸ‘¤ å›å ±äººå§“å(å¿…å¡«)
      <input type="text" id="reporter" placeholder="è«‹è¼¸å…¥å›å ±äººå§“å" />
    </label>

    <button id="createBtn">å»ºç«‹å¤§æ¨“ç•°å¸¸å ±å‘Š</button>

    <p style="text-align:left; margin-top:24px;">
      <a href="/abnormal-query.html" style="
        display: inline-block;
        padding: 10px 20px;
        background-color: #0400ff;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-weight: bold;
        ">
        ç•°å¸¸å ±å‘ŠæŸ¥è©¢
      </a>
    </p>
  </form>




  <script>
    // é€å‡ºè¡¨å–®
    document.getElementById('abnormalForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const payload = {
        displayId: document.getElementById('displayId').value,
        building: document.getElementById('building').value,
        type: document.getElementById('type').value,
        status: document.getElementById('status').value
      };

      const res = await fetch('/api/create-abnormal', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      alert(data.message);
    });

    // ä¸Šå‚³åˆ°å¾Œç«¯ï¼šåˆ†ä¸‰æ¬¡é€å‡ºæˆ–åŠ ä¸Šåˆ†é¡æ¨™ç±¤
    async function uploadPhotos(eventId, inputId, category) {
      const input = document.getElementById(inputId);
      const files = input.files;
      if (files.length === 0) return;

      const formData = new FormData();
      for (const f of files) {
        formData.append('files', f);
      }
      formData.append('category', category); // å‚³é€åˆ†é¡è³‡è¨Š

      const resp = await fetch(`/api/abnormal-events/${eventId}/files`, {
        method: 'POST',
        body: formData
      });
      if (!resp.ok) throw new Error(await resp.text());
    }

    // é€šç”¨å‡½å¼ä¾†è™•ç†é è¦½
    function setupPhotoPreview(inputId, previewId) {
      const input = document.getElementById(inputId);
      const preview = document.getElementById(previewId);

      input.addEventListener('change', () => {
        preview.innerHTML = '';
        for (const file of input.files) {
          const reader = new FileReader();
          reader.onload = () => {
            const img = document.createElement('img');
            img.src = reader.result;
            img.style.maxWidth = '120px';
            img.style.margin = '6px';
            img.style.borderRadius = '6px';
            preview.appendChild(img);
          };
          reader.readAsDataURL(file);
        }
      });
    }

    setupPhotoPreview('photoInitial', 'previewInitial');
    setupPhotoPreview('photoProcessing', 'previewProcessing');
    setupPhotoPreview('photoResolved', 'previewResolved');

    const buildingMap = {
      'å°åŒ—åŒ—å€': ['äºå¤ªç¶“è²¿'],
      'å°åŒ—å—å€': ['æ¾å±±é‡‘è', 'å‰ç»é‡‘è', 'å…¨çƒæ°‘æ¬Š', 'ç”¢ç‰©å¤§æ¨“', 'èŠ·è‹±å¤§æ¨“', 'è¯èˆªå¤§æ¨“',
        'å—äº¬ç§‘æŠ€', 'äº’åŠ©ç‡Ÿé€ ', 'æ‘©å¤©å¤§æ¨“', 'æ–°èŠè¾²æœƒ', 'å„’é´»ä¼æ¥­', 'æ–°æ¿å‚‘ä»•å ¡',
        'æ–°æ¿é‡‘è', 'æ¡ƒåœ’é‡‘è', 'æ–°ç«¹å¤§æ¨“', 'ç«¹ç§‘å¤§æ¨“', 'é ­ä»½å¤§æ¨“'],
      'é†«ç™‚å°ˆå€': ['æ–°å…‰é†«é™¢'],
      'å°ç£ä¸­å€': ['å°ä¸­æƒ åœ‹'],
      'å°ç£å—å€': ['å°å—å¤§æ¨“']
    };

    const subTypeMap = {
      'å¤§æ¨“ç½å®³äº‹ä»¶': ['åœ°éœ‡', 'ç«ç½', 'é¢±é¢¨', 'æ°´ç½', 'ç™¼ç¾çˆ†è£‚ç‰©', 'å¤§æ¨“æ»²æ°´æˆ–ç©æ°´', 'å¤§æ¨“é­å—å¤–åŠ›å—æ', 'çˆ†æ°´ç®¡'],
      'å¤§æ¨“è¨­å‚™æ•…éšœ': ['åœç©ºèª¿', 'å¤§æ¨“åœæ°´', 'å¤§æ¨“åœé›»', 'æ±¡ã€å»¢ã€æ’æ°´ç³»çµ±', 'ç…§æ˜æ•…éšœ', 'é›»æ¢¯æ•…éšœ', 'éµæ²é–€æ•…éšœ', 'å¤–ç‰†ç»ç’ƒç ´æ', 'è»Šå ´æ”¶è²»ã€ç®¡åˆ¶ç³»çµ±', 'é›»è©±ç³»çµ±'],
      'æ„å¤–äº‹æ•…': ['ç«Šç›œäº‹ä»¶', 'äººå“¡å‚·äº¡', 'é›»æ¢¯é—œäºº', 'å¤–ç‰†æ¸…æ´—æ„å¤–äº‹ä»¶', 'äººå“¡ç‰¹æ®Šç•°å¸¸äº‹ä»¶', 'äººå“¡é—–é ‚æ¨“'],
      'å…¶ä»–äº‹ä»¶': ['è­¦å¯Ÿè‡³å¤§æ¨“è¾¦æ¡ˆ', 'ç¾¤çœ¾æŠ—çˆ­', 'åª’é«”å ±å°äº‹ä»¶', 'ç„¡é è­¦ç„¡äººè¾¦å…¬', 'æ¶ˆé˜²éšŠåˆ°å¤§æ¨“', 'æ•‘è­·è»Šåˆ°å¤§æ¨“', 'å‹¤å‹™äººå“¡ç•°å¸¸äº‹ä»¶']
    };

    document.getElementById('zoneSelect').addEventListener('change', () => {
      const zone = document.getElementById('zoneSelect').value;
      const buildingSelect = document.getElementById('reportBuilding');
      buildingSelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>';

      if (zone && buildingMap[zone]) {
        for (const b of buildingMap[zone]) {
          const opt = document.createElement('option');
          opt.value = b;
          opt.textContent = b;
          buildingSelect.appendChild(opt);
        }
      }
    });

    document.getElementById('mainType').addEventListener('change', () => {
      const main = document.getElementById('mainType').value;
      const subSelect = document.getElementById('subType');
      subSelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>';

      if (subTypeMap[main]) {
        for (const sub of subTypeMap[main]) {
          const opt = document.createElement('option');
          opt.value = sub;
          opt.textContent = sub;
          subSelect.appendChild(opt);
        }
      }
    });


    // ä¿®æ”¹æ’ç‰ˆå¾Œç¨‹å¼ç¢¼
    document.getElementById('createBtn').addEventListener('click', async (e) => {
      e.preventDefault(); // âœ… é˜»æ­¢ <form> é è¨­æäº¤è¡Œç‚º

      // ğŸ“¥ å–å¾—æ‰€æœ‰æ¬„ä½å€¼
      const building = document.getElementById('reportBuilding').value.trim();
      const type = document.getElementById('mainType').value;
      const subtype = document.getElementById('subType').value;
      const locationText = document.getElementById('location').value.trim();
      const reason = document.getElementById('reason').value.trim();  // âœ…âœ…âœ…âœ…
      const occurTime = document.getElementById('occurTime').value;
      const phenomenon = document.getElementById('phenomenon').value.trim();
      const judgement = document.getElementById('judgement').value.trim();
      const handling = document.getElementById('handling').value.trim();
      const suggestion = document.getElementById('suggestion').value.trim();
      const reportedBy = document.getElementById('reporter').value.trim();


      // ğŸ§  çµ„åˆæè¿°æ–‡å­—
      const description = [phenomenon, judgement, handling, suggestion]
        .filter(Boolean)
        .join('\n\n'); // æ¯æ®µç©ºä¸€è¡Œ


      // ğŸš« æª¢æŸ¥å¿…å¡«æ¬„ä½
      if (!building || !type || !subtype || !description || !reportedBy || !location || !occurTime || !reason) {
        alert('â— è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');
        return;
      }

      try {
        // ğŸ“¤ å»ºç«‹äº‹ä»¶
        const resp = await fetch('/api/abnormal-events', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            building,
            type,
            subtype,
            description,
            reportedBy,
            location: locationText, // âœ… æ”¹æˆä¸è¡çªçš„åç¨±
            occurTime,
            phenomenon,
            judgement,
            handling,
            suggestion,
            reason  // âœ…âœ…âœ…âœ…
          })
        });

        if (!resp.ok) throw new Error(await resp.text());
        const data = await resp.json();

        // ğŸ“· ä¸Šå‚³åˆ†é¡ç…§ç‰‡ï¼ˆå¦‚æœ‰ï¼‰
        await uploadPhotos(data.displayId, 'photoInitial', 'initial');
        await uploadPhotos(data.displayId, 'photoProcessing', 'processing');
        await uploadPhotos(data.displayId, 'photoResolved', 'resolved');

        // ğŸ“· ä¸Šå‚³ä¸€èˆ¬ç…§ç‰‡ï¼ˆå¦‚æœ‰ï¼‰
        const photoInput = document.getElementById('photoInput');
        const files = photoInput.files;
        if (files.length > 0) {
          const formData = new FormData();
          for (const f of files) {
            formData.append('files', f);
          }
          const uploadResp = await fetch(`/api/abnormal-events/${data.displayId}/files`, {
            method: 'POST',
            body: formData
          });
          if (!uploadResp.ok) throw new Error(await uploadResp.text());
        }

        alert(`âœ… å»ºç«‹æˆåŠŸï¼Œäº‹ä»¶ç·¨è™Ÿï¼š${data.displayId}`);
        location.reload();
      } catch (err) {
        console.error('âŒ å»ºç«‹äº‹ä»¶éŒ¯èª¤:', err);
        alert('âŒ å»ºç«‹äº‹ä»¶éŒ¯èª¤ï¼š' + err.message);
      }
    });



    // âœ… JavaScriptï¼šåŠ å…¥é è¦½èˆ‡é€å‡ºç…§ç‰‡åŠŸèƒ½
    document.getElementById('photoInput').addEventListener('change', () => {
      const previewArea = document.getElementById('previewArea');
      previewArea.innerHTML = '';
      const files = photoInput.files;
      for (const f of files) {
        const reader = new FileReader();
        reader.onload = () => {
          const img = document.createElement('img');
          img.src = reader.result;
          img.style.maxWidth = '120px';
          img.style.margin = '6px';
          img.style.borderRadius = '6px';
          previewArea.appendChild(img);
        };
        reader.readAsDataURL(f);
      }
    });


    async function loadEvents() {
      const building = document.getElementById('filterBuilding')?.value || '';
      const type = document.getElementById('mainType')?.value || '';
      const query = new URLSearchParams();
      if (building) query.append('building', building);
      if (type) query.append('type', type);

      const eventTableBody = document.getElementById('eventTableBody');
      eventTableBody.innerHTML = '';

      try {
        const resp = await fetch(`/api/abnormal-events?${query.toString()}`);
        if (!resp.ok) throw new Error(await resp.text());
        const events = await resp.json();

        if (events.length === 0) {
          eventTableBody.innerHTML = `<tr><td colspan="7">ç›®å‰æ²’æœ‰å¤§æ¨“ç•°å¸¸å ±å‘Š</td></tr>`;
          return;
        }

        for (const e of events) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
        <td><a href="/abnormal-detail.html?id=${e.id}" target="_blank"><code>${e.displayId || e.id}</code></a></td>
        <td>${e.building}</td>
        <td>${e.type}</td>
        <td>${e.subtype || ''}</td>
        <td>${e.description}</td>
        <td>${new Date(e.createdAt).toLocaleString()}</td>
        <td>${e.status}</td>
      `;
          eventTableBody.appendChild(tr);
        }
      } catch (err) {
        console.error(err);
        eventTableBody.innerHTML = `<tr><td colspan="7">âŒ ç„¡æ³•è¼‰å…¥äº‹ä»¶ï¼š${err.message}</td></tr>`;
      }
    }

  </script>

</body>

</html>