<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <title>ä¿®æ”¹ç•°å¸¸å ±å‘Š</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }

    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
    }

    input,
    textarea {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      margin-top: 12px;
      padding: 8px 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    img {
      max-width: 160px;
      border-radius: 6px;
      margin-right: 12px;
      margin-bottom: 6px;
    }

    .image-block {
      margin-bottom: 16px;
    }

    .image-group {
      margin-bottom: 24px;
    }

    .image-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .image-card {
      border: 1px solid #ccc;
      padding: 8px;
      width: 160px;
      text-align: center;
      background: #f9f9f9;
      border-radius: 6px;
    }

    .thumbnail {
      width: 100%;
      height: auto;
      object-fit: cover;
    }

    .image-label {
      font-size: 12px;
      margin: 6px 0;
      color: #333;
    }

    .delete-button {
      background-color: #e74c3c;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }

    .delete-button:hover {
      background-color: #c0392b;
    }

    .image-card button {
      margin: 4px 2px;
    }
  </style>
</head>

<body>

  <h2>âœï¸ ä¿®æ”¹ç•°å¸¸å ±å‘Š</h2>

  <div id="formBox">
    <label>äº‹ä»¶ç·¨è™Ÿ</label>
    <input id="displayId" disabled />

    <label>å¤§æ¨“</label>
    <input id="building" disabled />

    <label>ä¸»é¡å‹</label>
    <input id="type" disabled />

    <label>ç•°å¸¸äº‹ç”±</label>
    <input id="reason" />

    <label>ç•°å¸¸æè¿°</label>
    <textarea id="description" rows="6"></textarea>

    <button onclick="saveEdit()">ğŸ’¾ å„²å­˜ä¿®æ”¹</button>

    <h3></h3>
    <div id="imageList"></div>

    <label>æ–°å¢åˆæ­¥ç…§ç‰‡</label>
    <input type="file" id="photoInitial" name="initial" multiple accept="image/*" />
    <button onclick="uploadImages('initial')">ğŸ“¤ ä¸Šå‚³åˆæ­¥</button>

    <label>æ–°å¢è™•ç†ä¸­ç…§ç‰‡</label>
    <input type="file" id="photoProcessing" name="processing" multiple accept="image/*" />
    <button onclick="uploadImages('processing')">ğŸ“¤ ä¸Šå‚³è™•ç†ä¸­</button>

    <label>æ–°å¢å®Œæˆç…§ç‰‡</label>
    <input type="file" id="photoResolved" name="resolved" multiple accept="image/*" />
    <button onclick="uploadImages('resolved')">ğŸ“¤ ä¸Šå‚³å®Œæˆ</button>

    <label>æ–°å¢å…¶ä»–ç…§ç‰‡</label>
    <input type="file" id="photoGeneral" name="general" multiple accept="image/*" />
    <button onclick="uploadImages('general')">ğŸ“¤ ä¸Šå‚³å…¶ä»–</button>




  </div>

  <script>

    //é è¦½åœ–ç‰‡ç•«é¢æ’ç‰ˆ
    async function renderImages(files) {
      const container = document.getElementById('imageList');
      container.innerHTML = '';

      if (!files || !Array.isArray(files)) return;

      const categories = ['initial', 'processing', 'resolved', 'general'];

      // âœ… é¡åˆ¥ä¸­æ–‡æ¨™ç±¤å°æ‡‰è¡¨
      const categoryLabels = {
        initial: 'ğŸ“¸ åˆæ­¥ç™¼ç”Ÿç…§ç‰‡',
        processing: 'ğŸ› ï¸ è™•ç†ä¸­ç…§ç‰‡',
        resolved: 'âœ… è™•ç†å®Œæˆç…§ç‰‡',
        general: 'ğŸ“‚ å…¶ä»–ç…§ç‰‡'
      };

      const grouped = {};
      for (const cat of categories) {
        grouped[cat] = files.filter(f => f.category === cat);
      }

      for (const cat of categories) {
        const group = grouped[cat];
        if (!group.length) continue;

        const section = document.createElement('div');
        section.className = 'image-group';

        const title = document.createElement('h4');
        title.textContent = categoryLabels[cat] || `ğŸ“‚ é¡åˆ¥ï¼š${cat}`; // âœ… å¥—ç”¨ä¸­æ–‡æ¨™ç±¤
        section.appendChild(title);

        const row = document.createElement('div');
        row.className = 'image-row';

        for (const f of group) {
          const filename = f.filename || (f.url?.split('/').pop());
          if (!filename) continue;

          const card = document.createElement('div');
          card.className = 'image-card';

          const img = document.createElement('img');
          img.src = f.url;
          img.alt = f.originalname || filename;
          img.className = 'thumbnail';

          const label = document.createElement('div');
          label.className = 'image-label';
          label.textContent = f.originalname || filename;

          const delBtn = document.createElement('button');
          delBtn.textContent = 'ğŸ—‘ï¸ åˆªé™¤';
          delBtn.className = 'delete-button'; // âœ… åŠ ä¸Šç´…è‰²æ¨£å¼
          delBtn.onclick = () => deleteImage(filename);

          const viewBtn = document.createElement('button');
          viewBtn.textContent = 'ğŸ” æŸ¥çœ‹';
          viewBtn.onclick = () => window.open(f.url, '_blank');

          card.appendChild(img);
          card.appendChild(label);

          card.appendChild(delBtn);
          row.appendChild(card);
        }

        section.appendChild(row);
        container.appendChild(section);
      }
    }



    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    async function loadEvent() {
      const id = new URLSearchParams(location.search).get('id');
      if (!id) return alert('â— ç¼ºå°‘äº‹ä»¶ç·¨è™Ÿ');

      const resp = await fetch(`/api/abnormal-events/${id}`);
      if (!resp.ok) return alert('âŒ ç„¡æ³•è¼‰å…¥äº‹ä»¶');

      const data = await resp.json();
      document.getElementById('displayId').value = data.displayId || data.id;
      document.getElementById('building').value = data.building;
      document.getElementById('type').value = data.type;
      document.getElementById('reason').value = data.reason || '';
      document.getElementById('description').value = data.description || '';
      renderImages(data.files || []);

      currentDisplayId = data.displayId;

    }

    async function saveEdit() {
      const id = new URLSearchParams(location.search).get('id');
      const reason = document.getElementById('reason').value;
      const description = document.getElementById('description').value;



      const resp = await fetch(`/api/abnormal-events/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reason, description })
      });

      if (!resp.ok) return alert('âŒ ä¿®æ”¹å¤±æ•—');
      alert('âœ… ä¿®æ”¹æˆåŠŸ');
      location.href = `/abnormal-detail.html?id=${id}`;
    }



    async function deleteImage(filename) {
      const id = new URLSearchParams(location.search).get('id');
      const resp = await fetch(`/api/abnormal-events/${id}/files/${filename}`, { method: 'DELETE' });
      if (!resp.ok) return alert('âŒ åˆªé™¤å¤±æ•—');
      alert('âœ… å·²åˆªé™¤åœ–ç‰‡');
      loadEvent();
    }

    function getInputId(category) {
      const map = {
        initial: 'photoInitial',
        processing: 'photoProcessing',
        resolved: 'photoResolved',
        general: 'photoGeneral'
      };
      return map[category];
    }

    async function uploadImages(category) {
      const allowedFields = ['initial', 'processing', 'resolved', 'general'];
      if (!allowedFields.includes(category)) {
        alert(`âŒ ç„¡æ•ˆçš„åˆ†é¡æ¬„ä½ï¼š${category}`);
        return;
      }

      // âœ… å¾å…¨åŸŸè®Šæ•¸å–å¾— displayIdï¼ˆè«‹åœ¨ loadEvent() æ™‚è¨­å®šï¼‰
      const displayId = currentDisplayId;
      if (!displayId || typeof displayId !== 'string') {
        alert('âŒ ç„¡æ³•å–å¾— displayIdï¼Œè«‹ç¢ºèªäº‹ä»¶è³‡æ–™æ˜¯å¦æ­£ç¢ºè¼‰å…¥');
        return;
      }

      const inputId = getInputId(category);
      const fileInput = document.getElementById(inputId);
      const files = fileInput?.files;

      if (!files || !files.length) {
        alert('â— è«‹é¸æ“‡åœ–ç‰‡');
        return;
      }

      let successCount = 0;
      let failList = [];

      for (const file of files) {
        const formData = new FormData();
        formData.append('files', file);
        formData.append('category', category);

        try {
          const resp = await fetch(`/api/abnormal-events/${encodeURIComponent(displayId)}/files`, {
            method: 'POST',
            body: formData
          });

          if (resp.ok) {
            successCount++;
          } else {
            failList.push(file.name);
            const errorText = await resp.text();
            console.error(`âŒ ä¸Šå‚³å¤±æ•—ï¼š${file.name}`, errorText);
          }
        } catch (err) {
          failList.push(file.name);
          console.error(`âŒ fetch ç™¼ç”ŸéŒ¯èª¤ï¼š${file.name}`, err);
        }
      }

      fileInput.value = '';

      if (failList.length) {
        alert(`âŒ ä¸Šå‚³å¤±æ•—ï¼š${failList.join(', ')}`);
      }

      if (successCount > 0) {
        alert(`âœ… æˆåŠŸä¸Šå‚³ ${successCount} å¼µåœ–ç‰‡`);
        loadEvent(); // é‡æ–°è¼‰å…¥äº‹ä»¶è³‡æ–™
      }
    }

    async function uploadDebugAll() {
      const id = new URLSearchParams(location.search).get('displayId');
      const categories = ['initial', 'processing', 'resolved', 'general'];
      const results = [];

      for (const category of categories) {
        const inputId = getInputId(category);
        const fileInput = document.getElementById(id);
        const files = fileInput?.files;

        if (!files || !files.length) {
          results.push(`âŒ ${category}: æœªé¸æ“‡åœ–ç‰‡`);
          continue;
        }

        const formData = new FormData();
        formData.append(category, files[0]); // åªæ¸¬è©¦ç¬¬ä¸€å¼µ
        formData.append('category', category);

        try {
          const resp = await fetch(`/api/abnormal-events/${id}/files-debug`, {
            method: 'POST',
            body: formData
          });
          const result = await resp.json();
          console.log(`ğŸ ${category} æ¸¬è©¦çµæœ:`, result);
          results.push(`âœ… ${category}: æˆåŠŸ (${result.receivedFiles?.[0]})`);
        } catch (err) {
          console.error(`âŒ ${category} æ¸¬è©¦éŒ¯èª¤:`, err);
          results.push(`âŒ ${category}: éŒ¯èª¤ ${err.message}`);
        }
      }

      alert('ğŸ æ¸¬è©¦å®Œæˆï¼š\n' + results.join('\n'));
    }


    loadEvent();
  </script>

</body>

</html>