<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <title>ä¿®æ”¹ç•°å¸¸äº‹ä»¶</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }

    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
    }

    input,
    textarea {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      margin-top: 12px;
      padding: 8px 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    img {
      max-width: 160px;
      border-radius: 6px;
      margin-right: 12px;
      margin-bottom: 6px;
    }

    .image-block {
      margin-bottom: 16px;
    }
  </style>
</head>

<body>

  <h2>âœï¸ ä¿®æ”¹ç•°å¸¸äº‹ä»¶</h2>

  <div id="formBox">
    <label>äº‹ä»¶ç·¨è™Ÿ</label>
    <input id="displayId" disabled />

    <label>å¤§æ¨“</label>
    <input id="building" disabled />

    <label>ä¸»é¡å‹</label>
    <input id="type" disabled />

    <label>ç•°å¸¸äº‹ç”±</label>
    <input id="reason" />

    <label>ç•°å¸¸æè¿°</label>
    <textarea id="description" rows="6"></textarea>

    <button onclick="saveEdit()">ğŸ’¾ å„²å­˜ä¿®æ”¹</button>

    <h3>ğŸ“¸ é™„åœ–ç®¡ç†</h3>
    <div id="imageList"></div>

    <label>æ–°å¢åˆæ­¥ç…§ç‰‡</label>
    <input type="file" id="photoInitial" name="initial" multiple accept="image/*" />
    <button onclick="uploadImages('initial')">ğŸ“¤ ä¸Šå‚³åˆæ­¥</button>

    <label>æ–°å¢è™•ç†ä¸­ç…§ç‰‡</label>
    <input type="file" id="photoProcessing" name="processing" multiple accept="image/*" />
    <button onclick="uploadImages('processing')">ğŸ“¤ ä¸Šå‚³è™•ç†ä¸­</button>


    <label>æ–°å¢å®Œæˆç…§ç‰‡</label>
    <input type="file" id="photoResolved" name="resolved" multiple accept="image/*" />
    <button onclick="uploadImages('resolved')">ğŸ“¤ ä¸Šå‚³å®Œæˆ</button>

    <label>æ–°å¢å…¶ä»–ç…§ç‰‡</label>
    <input type="file" id="photoInput" name="other" multiple accept="image/*" />
    <button onclick="uploadImages('other')">ğŸ“¤ ä¸Šå‚³å…¶ä»–</button>
  </div>

  <script>

    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    async function loadEvent() {
      const id = new URLSearchParams(location.search).get('id');
      if (!id) return alert('â— ç¼ºå°‘äº‹ä»¶ç·¨è™Ÿ');

      const resp = await fetch(`/api/abnormal-events/${id}`);
      if (!resp.ok) return alert('âŒ ç„¡æ³•è¼‰å…¥äº‹ä»¶');

      const data = await resp.json();
      document.getElementById('displayId').value = data.displayId || data.id;
      document.getElementById('building').value = data.building;
      document.getElementById('type').value = data.type;
      document.getElementById('reason').value = data.reason || '';
      document.getElementById('description').value = data.description || '';
      renderImages(data.files || []);
    }

    async function saveEdit() {
      const id = new URLSearchParams(location.search).get('id');
      const reason = document.getElementById('reason').value;
      const description = document.getElementById('description').value;

      const pwd = prompt('è«‹è¼¸å…¥ä¿®æ”¹å¯†ç¢¼');
      if (pwd !== '2301') return alert('âŒ å¯†ç¢¼éŒ¯èª¤');

      const resp = await fetch(`/api/abnormal-events/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reason, description })
      });

      if (!resp.ok) return alert('âŒ ä¿®æ”¹å¤±æ•—');
      alert('âœ… ä¿®æ”¹æˆåŠŸ');
      location.href = `/abnormal-detail.html?id=${id}`;
    }

    async function renderImages(files) {
      const container = document.getElementById('imageList');
      container.innerHTML = '';
      for (const f of files) {
        const filename = f.filename || (f.url?.split('/').pop());
        if (!filename) continue;

        const block = document.createElement('div');
        block.className = 'image-block';

        const label = document.createElement('div');
        label.textContent = `ğŸ“‚ åˆ†é¡ï¼š${f.category || 'æœªåˆ†é¡'}`;
        label.style.fontSize = '13px';
        label.style.color = '#555';

        const img = document.createElement('img');
        img.src = f.url;

        const delBtn = document.createElement('button');
        delBtn.textContent = 'ğŸ—‘ï¸ åˆªé™¤';
        delBtn.onclick = () => deleteImage(filename);

        block.appendChild(label);
        block.appendChild(img);
        block.appendChild(delBtn);
        container.appendChild(block);
      }
    }

    async function deleteImage(filename) {
      const id = new URLSearchParams(location.search).get('id');
      const resp = await fetch(`/api/abnormal-events/${id}/files/${filename}`, { method: 'DELETE' });
      if (!resp.ok) return alert('âŒ åˆªé™¤å¤±æ•—');
      alert('âœ… å·²åˆªé™¤åœ–ç‰‡');
      loadEvent();
    }

    function getInputId(category) {
      const map = {
        initial: 'photoInitial',
        processing: 'photoProcessing',
        resolved: 'photoResolved',
        other: 'photoInput'
      };
      return map[category];
    }

    async function uploadImages(category) {
      const id = new URLSearchParams(location.search).get('id');
      const inputId = getInputId(category);
      const fileInput = document.getElementById(inputId);
      const files = fileInput?.files;
      if (!files || !files.length) return alert('â— è«‹é¸æ“‡åœ–ç‰‡');

      let successCount = 0;
      let failList = [];

      for (const file of files) {
        const formData = new FormData();
        formData.append(category, file);
        formData.append('category', category);

        const resp = await fetch(`/api/abnormal-events/${id}/files`, {
          method: 'POST',
          body: formData
        });

        if (resp.ok) {
          successCount++;
        } else {
          failList.push(file.name);
          const errorText = await resp.text();
          console.error(`âŒ ä¸Šå‚³å¤±æ•—ï¼š${file.name}`, errorText);
        }
      }

      if (failList.length) alert(`âŒ ä¸Šå‚³å¤±æ•—ï¼š${failList.join(', ')}`);
      if (successCount > 0) {
        alert(`âœ… æˆåŠŸä¸Šå‚³ ${successCount} å¼µåœ–ç‰‡`);
        loadEvent();
      }
    }

    loadEvent();
  </script>

</body>

</html>